{% extends "base.html" %}
{% load static %}

{% block title %}
  오늘의 퀴즈 - 중국어 단어장
{% endblock title %}

{% block head %}
<style>
    .quiz-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
        max-width: 700px;
        margin: 0 auto;
        padding: 1rem;
    }

    .quiz-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        width: 100%;
        padding: 3rem 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        border: 4px solid transparent; /* Initial border */
    }
    
    .quiz-card.correct {
        border-color: #2ecc71;
        box-shadow: 0 10px 40px rgba(46, 204, 113, 0.2);
    }
    
    .quiz-card.wrong {
        border-color: #e74c3c;
        box-shadow: 0 10px 40px rgba(231, 76, 60, 0.2);
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background-color: #f1f3f5;
        border-radius: 4px;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        width: 0%;
        transition: width 0.3s ease;
    }

    .word-display {
        font-size: 3.5rem;
        font-weight: 800;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        line-height: 1.2;
    }
    
    /* Word Info */
    .word-info-container {
        margin-bottom: 3rem;
        position: relative;
    }
    
    .badge-custom {
        display: inline-block;
        padding: 0.4rem 1rem;
        font-size: 0.95rem;
        font-weight: 600;
        color: #fff;
        background-color: #8e44ad; /* Purple shade from image */
        border-radius: 20px;
        margin-top: 0.5rem;
        box-shadow: 0 4px 6px rgba(142, 68, 173, 0.2);
    }

    /* Input Grid */
    .input-grid {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        width: 100%;
        margin-bottom: 2rem;
        align-items: center; 
    }

    .input-row {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative; /* Key for absolute label */
        width: auto; /* Let it shrink to content */
    }

    .row-label {
        position: absolute;
        right: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-right: 2rem; /* Spacing from input */
        font-weight: 700;
        font-size: 1rem;
        color: #2c3e50;
        white-space: nowrap;
    }

    .row-inputs {
        display: flex;
        gap: 0.8rem;
        justify-content: center;
    }

    .input-box-style {
        width: 100px;
        height: 55px; 
        text-align: center;
        font-size: 1.3rem; 
        border: 2px solid #e9ecef;
        border-radius: 12px;
        outline: none;
        background: white;
        transition: border-color 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Wrapper to align 60px tone box with 100px pinyin input */
    .tone-wrapper {
        width: 100px; /* Match input width */
        height: 40px; /* Match tone height */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Tone Display specific */
    .tone-display {
        width: 60px; 
        height: 40px; 
        background-color: #f1f3f5;
        color: #495057;
        font-weight: 700;
        font-size: 1.4rem;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
    }
        background-color: #f1f3f5;
        color: #495057;
        font-weight: 700;
        font-size: 1.4rem;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .tone-select {
        /* Not used currently but kept for safe measures or if reverted */
        display: none; 
    }
    
    .pinyin-input {
        background-color: #fff;
    }
    
    .input-box-style:focus {
        border-color: #4facfe;
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
    }
    
    .meaning-label-row {
        text-align: left;
        margin-bottom: 0.5rem;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .meaning-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        outline: none;
        transition: border-color 0.2s;
    }
    
    /* Center alignment container tweak */
    .quiz-form-container {
        max-width: 500px;
        margin: 0 auto;
        text-align: left;
    }

    /* Word info spacing */
    /* Moved up */

    /* Buttons */
    .btn-action {
        width: 100%;
        height: 60px; /* Fixed height for consistent vertical align */
        padding: 0;   /* Use flex for centering */
        font-size: 1.2rem;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        color: white;
        transition: all 0.2s;
        margin-top: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-next {
        background: #2c3e50;
        display: none; 
    }
    
    .btn-action:active {
        transform: scale(0.98);
    }
    
    .correct-answer-display {
        background: #fdf2f2;
        color: #c0392b;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        display: none;
        text-align: left;
    }
    
    .correct-answer-display.success-mode {
         background: #d4edda;
         color: #155724;
    }

    /* Completion Screen */
    .completion-screen {
        display: none;
        text-align: center;
    }
    .completion-screen.visible {
        display: block;
    }

    /* Validation Effects */
    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        50% { transform: translateX(10px); }
        75% { transform: translateX(-10px); }
        100% { transform: translateX(0); }
    }
    
    .shake {
        animation: shake 0.4s ease-in-out;
    }
    
    .border-warning-custom {
        border-color: #f1c40f !important; /* Yellow */
        box-shadow: 0 0 0 4px rgba(241, 196, 15, 0.2) !important;
    }
    
    .warning-text {
        color: #e74c3c;
        font-size: 0.8rem;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s;
        position: absolute;
        bottom: -24px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        pointer-events: none;
        z-index: 10;
        text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    }

</style>
{% endblock head %}

{% block content %}
<div class="quiz-container">
    
    <!-- Quiz Card -->
    <div id="quiz-card" class="quiz-card">
        <!-- Progress -->
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar-fill"></div>
        </div>
        <div class="text-end text-muted mb-2 small">
            <span id="current-count">1</span> / <span id="total-count">0</span>
        </div>

        <!-- Word -->
        <div class="word-info-container">
            <div id="word-display" class="word-display">Word</div>
            <div id="word-class-badge" class="badge-custom">Class</div>
        </div>

        <!-- Inputs -->
        <div class="quiz-form-container">
            <form id="quiz-form" autocomplete="off">
                <div class="input-grid">
                    <!-- Tone Row -->
                    <div class="input-row">
                        <div class="row-label">성조</div>
                        <div id="tone-container" class="row-inputs">
                            <!-- Injected JS -->
                        </div>
                    </div>
                    
                    <!-- Pinyin Row -->
                    <div class="input-row">
                        <div class="row-label">병음</div>
                        <div id="pinyin-container" class="row-inputs">
                            <!-- Injected JS -->
                        </div>
                        <div id="pinyin-warning" class="warning-text">한글은 입력할 수 없습니다.</div>
                    </div>
                </div>

                <!-- Meaning -->
                <div class="mb-3 position-relative">
                    <div class="meaning-label-row">
                        <i class="fas fa-language"></i> 의미
                    </div>
                    <input type="text" id="input-meaning" class="meaning-input" placeholder="의미를 입력하세요" required>
                    <div id="meaning-warning" class="warning-text">영문은 입력할 수 없습니다.</div>
                </div>
                
                <!-- Result Display -->
                <div id="correct-answer-box" class="correct-answer-display">
                    <!-- Filled via JS -->
                </div>

                <button type="submit" id="btn-submit" class="btn-action btn-submit">제출하기</button>
                <button type="button" id="btn-next" class="btn-action btn-next">다음 단어</button>
            </form>
        </div>
    </div>

    <!-- Completion Screen -->
    <div id="completion-screen" class="completion-screen">
        <div class="card p-5 shadow-sm border-0" style="border-radius: 20px;">
            <div class="text-success mb-4" style="font-size: 4rem;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="mb-3 font-weight-bold">모든 퀴즈 완료!</h2>
            <p class="text-muted mb-4">오늘의 복습을 훌륭하게 마치셨습니다.</p>
            <a href="{% url 'words:index' %}" class="btn btn-primary btn-lg rounded-pill px-5">
                메인으로 돌아가기
            </a>
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from Backend
    const initialWords = JSON.parse('{{ words_data_json|escapejs }}');
    
    // Helper Maps (Moved to top to avoid ReferenceError)
    const toneMarkMap = {'1': 'ˉ', '2': 'ˊ', '3': 'ˇ', '4': 'ˋ', '5': '˙'};
    
    // State
    let quizQueue = [...initialWords]; 
    let initialTotal = initialWords.length;
    let completedCount = 0; 
    let isReviewMode = false; // "Next" button state
    
    // DOM Elements
    const quizCard = document.getElementById('quiz-card');
    const completionScreen = document.getElementById('completion-screen');
    
    const wordDisplay = document.getElementById('word-display');
    const wordClassBadge = document.getElementById('word-class-badge');
    const pinyinContainer = document.getElementById('pinyin-container');
    const toneContainer = document.getElementById('tone-container');
    const inputMeaning = document.getElementById('input-meaning');
    const correctAnswerBox = document.getElementById('correct-answer-box');
    
    const btnSubmit = document.getElementById('btn-submit');
    const btnNext = document.getElementById('btn-next');
    const quizForm = document.getElementById('quiz-form');
    
    const progressBar = document.getElementById('progress-bar');
    const currentCountEl = document.getElementById('current-count');
    const totalCountEl = document.getElementById('total-count');

    // Init
    totalCountEl.textContent = initialTotal;
    updateProgress();
    
    const meaningWarning = document.getElementById('meaning-warning');
    let warningTimeout;

    // Real-time Validation: Meaning (No English)
    inputMeaning.addEventListener('input', function() {
        const original = this.value;
        const cleaned = original.replace(/[a-zA-Z]/g, '');
        
        if (original !== cleaned) {
            this.value = cleaned;
            
            // Show Feedback
            if (meaningWarning) {
                meaningWarning.style.opacity = '1';
                clearTimeout(warningTimeout);
                warningTimeout = setTimeout(() => {
                    meaningWarning.style.opacity = '0';
                }, 2000);
            }
        }
    });
    
    if (quizQueue.length > 0) {
        renderQuestion();
    } else {
        showCompletion();
    }

    // Handlers
    quizForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!isReviewMode) {
            submitAnswer();
        }
    });

    btnNext.addEventListener('click', function() {
        if (isReviewMode) {
            nextQuestion();
        }
    });
    
    // Helper Maps (Moved to top)

    function renderQuestion() {
        try {
            if (quizQueue.length === 0) {
                showCompletion();
                return;
            }
    
            // Reset State
            isReviewMode = false;
            quizCard.className = 'quiz-card'; // remove correct/wrong
            btnSubmit.style.display = 'flex'; // Changed to flex for centering
            btnNext.style.display = 'none';
            correctAnswerBox.style.display = 'none';
            correctAnswerBox.classList.remove('success-mode');
            
            const word = quizQueue[0];
            wordDisplay.textContent = word.word;
            wordClassBadge.textContent = word.word_class;
            
            // Containers Check
            if (!pinyinContainer || !toneContainer) {
                console.error("Containers missing");
                return;
            }
            
            // Parse Tone
            // Safety: ensure string
            const toneStr = String(word.tone || "");
            // Fix: Split by comma OR space, and filter empty
            const correctTones = toneStr.trim().split(/[\s,]+/).filter(t => t);
            
            // Render Pinyin Inputs & Tone Displays
            // Safety: ensure pinyin is string
            const pinyinStr = String(word.pinyin || "").trim();
            if (!pinyinStr) {
                // If no pinyin, just empty
                pinyinContainer.innerHTML = '<div class="text-danger">데이터 오류: 병음 없음</div>';
                toneContainer.innerHTML = '';
                return;
            }
            
            const syllables = pinyinStr.split(/\s+/);
            pinyinContainer.innerHTML = '';
            toneContainer.innerHTML = '';
            
            syllables.forEach((syl, index) => {
                // Tone Display (Pre-filled)
                // Use a wrapper to enforce 100px width for alignment with Pinyin inputs
                const tWrapper = document.createElement('div');
                tWrapper.className = 'tone-wrapper';
                
                const tDiv = document.createElement('div');
                tDiv.className = 'tone-display';
                
                // Get correct tone for this syllable
                let toneNum = (index < correctTones.length) ? correctTones[index] : '';
                
                // Display Mark if possible, else Number
                let displayChar = toneMarkMap[toneNum] || toneNum || '-';
                tDiv.textContent = displayChar;
                tDiv.dataset.tone = toneNum; 
                
                tWrapper.appendChild(tDiv);
                toneContainer.appendChild(tWrapper);
                
                // Pinyin Input
                const pInput = document.createElement('input');
                pInput.type = 'text';
                pInput.className = 'pinyin-input input-box-style';
                pInput.dataset.index = index;
                pInput.placeholder = `병음${index+1}`;
                pInput.required = true;
                
                if (index === 0) setTimeout(() => pInput.focus(), 100);
                
                pinyinContainer.appendChild(pInput);
                
                // Real-time Validation: Pinyin (No Korean)
                pInput.addEventListener('input', function() {
                    const original = this.value;
                    const cleaned = original.replace(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/g, '');
                    
                    if (original !== cleaned) {
                        this.value = cleaned;
                        
                        // Show Warning
                        const pWarning = document.getElementById('pinyin-warning');
                        if (pWarning) {
                            pWarning.style.opacity = '1';
                            if (pWarning.timer) clearTimeout(pWarning.timer);
                            pWarning.timer = setTimeout(() => {
                                pWarning.style.opacity = '0';
                            }, 2000);
                        }
                    }
                });
            });
    
            // Meaning Hint
            const mLen = word.meaning_length || 0;
            inputMeaning.value = '';
            inputMeaning.placeholder = mLen > 0 ? `단어의 의미를 입력하세요 (길이 ${mLen})` : '단어의 의미를 입력하세요';
            
            updateProgress();
        } catch (err) {
            console.error(err);
            alert("렌더링 오류 발생: " + err.message);
        }
    }

    function submitAnswer() {
        const word = quizQueue[0];
        
        // Gather Pinyin Input
        const pInputs = document.querySelectorAll('.pinyin-input');
        
        // Gather Pre-filled Tones
        const tDisplays = document.querySelectorAll('.tone-display');
        
        // Combine Pinyin Inputs (Raw, no tone conversion needed for backend check)
        const combinedPinyin = Array.from(pInputs).map(input => input.value.trim()).join(' ');

        const mValue = inputMeaning.value.trim();
        
        // Validation: Block Submission if invalid chars exist (Fallback)
        // Pinyin: No Korean, Meaning: No English
        if (/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(combinedPinyin) || /[a-zA-Z]/.test(mValue)) {
            triggerShakeWarning();
            return;
        }
        
        // API Call
        fetch('{% url "words:api_grade_word" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                word_id: word.id,
                pinyin: combinedPinyin, // Sent correct format
                meaning: mValue
            })
        })
        .then(response => response.json())
        .then(data => {
             handleResult(data);
        })
        .catch(err => {
            console.error(err);
            alert('오류가 발생했습니다.');
        });
    }
    
    function triggerShakeWarning() {
        quizCard.classList.remove('shake', 'border-warning-custom');
        void quizCard.offsetWidth; // Trigger reflow
        quizCard.classList.add('shake', 'border-warning-custom');
        
        setTimeout(() => {
            quizCard.classList.remove('shake', 'border-warning-custom');
        }, 1000);
    }

    // Helper for Tone Conversion
    function convertToTone(text, toneVal) {
        if (!toneVal || toneVal === '5') return text; // Neutral or 5th
        
        const vowels = {
            'a': ['ā', 'á', 'ǎ', 'à'],
            'e': ['ē', 'é', 'ě', 'è'],
            'i': ['ī', 'í', 'ǐ', 'ì'],
            'o': ['ō', 'ó', 'ǒ', 'ò'],
            'u': ['ū', 'ú', 'ǔ', 'ù'],
            'v': ['ǖ', 'ǘ', 'ǚ', 'ǜ'],
            'ü': ['ǖ', 'ǘ', 'ǚ', 'ǜ'],
        };
        
        let chars = text.split('');
        let bestIdx = -1;
        
        // Priority: a, e, o
        // iu/ui handling
        
        if (text.includes("iu")) {
             bestIdx = text.lastIndexOf("u");
        } else if (text.includes("ui")) {
             bestIdx = text.lastIndexOf("i");
        } else {
            for (let char of "aoe") {
                if (text.includes(char)) {
                    bestIdx = text.indexOf(char);
                    break;
                }
            }
            if (bestIdx === -1) {
                for (let i=chars.length-1; i>=0; i--) {
                    if ("iuvü".includes(chars[i])) {
                        bestIdx = i;
                        break;
                    }
                }
            }
        }
        
        if (bestIdx !== -1) {
            const char = chars[bestIdx];
            const toneIdx = parseInt(toneVal) - 1;
            if (vowels[char] && vowels[char][toneIdx]) {
                chars[bestIdx] = vowels[char][toneIdx];
            }
        }
        
        return chars.join('');
    }

    function handleResult(data) {
        // UI Updates
        isReviewMode = true;
        btnSubmit.style.display = 'none';
        btnNext.style.display = 'flex'; // Flex for center
        btnNext.focus(); 

        if (data.is_correct) {
            quizCard.classList.add('correct');
            
            // Success Message
            correctAnswerBox.style.display = 'block';
            correctAnswerBox.classList.add('success-mode');
            
            let message = '훌륭해요!';
            if (data.next_review_delta) {
                if (data.next_review_delta === 1) {
                    message = '내일 다시 복습해요!';
                } else {
                    message = `${data.next_review_delta}일 뒤에 다시 만나요!`;
                }
            }

            correctAnswerBox.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="fw-bold" style="font-size: 1.1rem;">정답입니다!</div>
                        <div class="small">${message}</div>
                    </div>
                </div>
            `;
            
            // Logic Update
            quizQueue.shift();
            completedCount++;
        } else {
            quizCard.classList.add('wrong');
            // Show correct answer
            correctAnswerBox.style.display = 'block';
            correctAnswerBox.classList.remove('success-mode');
            
            const originalTerm = data.original_learning_term || 0;
            
            correctAnswerBox.innerHTML = `
                <div class="fw-bold mb-1">오답입니다</div>
                <div class="mb-2">정답: <span class="fw-bold text-dark">${data.correct_pinyin}</span> (${data.correct_meaning})</div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="small text-muted">이 단어는 잠시 후 다시 출제됩니다.</div>
                    <button type="button" class="btn btn-sm btn-outline-success" id="btn-mark-correct" 
                        onclick="markAsCorrect(${quizQueue[0].id}, ${originalTerm})">
                        정답으로 처리하기
                    </button>
                </div>
            `;
            
            // Logic Update
            const wrongWord = quizQueue.shift();
            quizQueue.push(wrongWord);
        }
    }

    // Expose to window so onclick works
    window.markAsCorrect = function(wordId, originalTerm) {
        if (!confirm('정말로 정답으로 처리하시겠습니까?')) return;
        
        // Disable button to prevent double click
        const btn = document.getElementById('btn-mark-correct');
        if(btn) btn.disabled = true;

        fetch('{% url "words:api_mark_as_correct" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                word_id: wordId,
                original_learning_term: originalTerm
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // UI Transition to Correct state
                quizCard.classList.remove('wrong');
                quizCard.classList.add('correct');
                
                correctAnswerBox.classList.add('success-mode');
                
                let message = '정답으로 처리되었습니다.';
                if (data.next_review_delta) {
                     if (data.next_review_delta === 1) {
                        message = '내일 다시 복습해요!';
                    } else {
                        message = `${data.next_review_delta}일 뒤에 다시 만나요!`;
                    }
                }

                correctAnswerBox.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <div class="fw-bold" style="font-size: 1.1rem;">정답으로 변경되었습니다!</div>
                            <div class="small">${message}</div>
                        </div>
                    </div>
                `;
                
                // Logic Fix
                // We pushed it to the back earlier. We need to remove it from the back.
                // Because we just "passed" it.
                // However, queue logic: 
                // Wrong -> Shift front, push back.
                // Correction -> We want it treated as DONE. 
                // So remove the last element (which is the one we pushed).
                quizQueue.pop(); 
                
                completedCount++;
            } else {
                alert('오류: ' + data.message);
                if(btn) btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert('통신 오류가 발생했습니다.');
            if(btn) btn.disabled = false;
        });
    };
    
    function nextQuestion() {
        renderQuestion();
    }

    function updateProgress() {
        currentCountEl.textContent = completedCount + 1;
        const progress = Math.min(100, (completedCount / initialTotal) * 100);
        progressBar.style.width = `${progress}%`;
        
        if (completedCount >= initialTotal) {
             currentCountEl.textContent = initialTotal;
        }
    }

    function showCompletion() {
        quizCard.style.display = 'none';
        completionScreen.classList.add('visible');
    }
});
</script>
{% endblock content %}
